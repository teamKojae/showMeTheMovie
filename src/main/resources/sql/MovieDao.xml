<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="com.show.movie.dao.MovieDao">
 
 	<resultMap id="movie" type="movie">
		<id column="movieCode" property="movieCode" />
		<result column="movieName" property="movieName" />
		<result column="movieAudience" property="movieAudience" />
		<result column="movieTicketRate" property="movieTicketRate" />
		<result column="movieTitle" property="movieTitle" />
		<result column="movieSynopsis" property="movieSynopsis" />
		<result column="moviePrice" property="moviePrice" />
		<result column="moviePoster" property="moviePoster" />
		<result column="moviePosterBG" property="moviePosterBG" />
	</resultMap> 
	
	<resultMap id="mvInfo" type="movieInfo">
		<result column="moiveInfoCode" property="moviePosterBG" />
		<!-- <result column="movieDate" property="movieDate" /> -->
		<result column="movieStartTime" property="movieStartTime" />
		<result column="movieEndTime" property="movieEndTime" />
				<association property="movie" javaType="movie">
						<result column="movieCode" property="movieCode" />
						<result column="movieName" property="movieName" />
						<result column="movieAudience" property="movieAudience" />
						<result column="movieTicketRate" property="movieTicketRate" />
						<result column="movieTitle" property="movieTitle" />
						<result column="movieSynopsis" property="movieSynopsis" />
						<result column="moviePrice" property="moviePrice" />
						<result column="moviePoster" property="moviePoster" />
						<result column="moviePosterBG" property="moviePosterBG" />
				</association>
				<association property="theater" javaType="theater">
					<result column="theaterCode" property="theaterCode" />
					<result column="theaterleftSeat" property="theaterLeftSeat" />
					<result column="theaterAllSeat" property="theaterAllSeat" />
				</association>
				<association property="branch" javaType="Branch">
					<result column="branchCode" property="branchCode" />
					<result column="branchName" property="branchName" />
					<association property="location" javaType="Location">
						<result column="locationCode" property="locationCode" /> 
						<result column="locationName" property="locationName" />
					</association>
				</association>
	</resultMap>
	
	
	<!-- 	
	private int theaterAllSeat;
	private int theaterleftSeat;
	@Autowired(required = false)
	private Movie movie;
	@Autowired(required = false)
	private Theater theater;
	@Autowired(required = false)
	private Branch branch;
	
	private int moiveInfoCode;
	//Date는 다른사람이 구현하면 하자.. ㅠ ㅠ 
	private Date movieDate;
	private String movieStartTime;
	private String movieEndTime; -->
	
 
	<select id="getMovie" resultMap="movie">
		SELECT movie.movieCode, movie.movieName, movie.movieAudience, movie.movieUpdate, movie.movieSynopsis,
		movie.moviePoster, movie.moviePosterBG, ranking.movieTicketRate, rankPersent.movieTicketRatePersent
		FROM movie,
		(SELECT round( ( (SELECT movieAudience from movie where movieName= #{movieName}) / sum(movie.movieAudience)  )*100, 1) 
		as movieTicketRatePersent FROM movie) AS rankPersent,
		(SELECT movieCode, Rank() over(order by movieAudience DESC) as movieTicketRate FROM movie) AS ranking
		 WHERE movie.movieCode = ranking.movieCode
		 AND movie.movieName = #{movieName};
	</select>
	
	<select id="getBranch" resultType="string" >
		SELECT branch.branchName FROM branch, location
		WHERE location.locationCode = branch.locationCode 
		AND location.locationName = #{locationName} 
	</select>
	
		
	<select id="getMovieInfo" resultType="movieInfo" parameterType="movieInfo">
		SELECT movie.movieName as 'movie.movieName',  movieStartTime , movieEndTime,
			   branch.branchName as 'branch.branchName', 
			   theater.theaterleftSeat as 'theater.theaterleftSeat', 
			   theater.theaterAllSeat as 'theater.theaterAllSeat', theater.theaterCode as 'theater.theaterCode' 
		FROM theater, movieInfo, movie , branch 
		WHERE theater.theaterCode = movieinfo.theaterCode
		AND movieinfo.movieCode = movie.movieCode 
		AND theater.branchCode = branch.branchCode 
		AND movie.movieName = #{movie.movieName}
		AND branch.branchName=  #{branch.branchName}
		ORDER BY movieStartTime ASC;
	</select>
	
<!-- 	
	CREATE VIEW getMovieInfo AS 
	SELECT movie.movieName, movieInfo.movieStartTime, movieInfo.movieEndTime, 
	branch.branchName, theater.theaterleftSeat,
	 theater.theaterAllSeat,
	 theater.theaterCode
	FROM movie AS movie , movieInfo AS movieInfo, theater AS theater, branch AS branch
	WHERE theater.theaterCode = movieinfo.theaterCode
	AND movieinfo.movieCode = movie.movieCode 
	AND theater.branchCode = branch.branchCode 
	ORDER BY movieStartTime ASC;
	
	Drop View getMovieInfo;
	
	select * from getMovieInfo where movieName = '다크워터스'
	
	CREATE VIEW getMovieInfo AS 
	SELECT movie.movieName as "movie.movieName", movieInfo.movieStartTime, movieInfo.movieEndTime, 
	branch.branchName as 'branch.branchName', theater.theaterleftSeat as 'theater.theaterleftSeat' ,
	 theater.theaterAllSeat as 'theater.theaterAllSeat',
	 theater.theaterCode as 'theater.theaterCode'
	FROM movie AS movie , movieInfo AS movieInfo, theater AS theater, branch AS branch
	WHERE theater.theaterCode = movieinfo.theaterCode
	AND movieinfo.movieCode = movie.movieCode 
	AND theater.branchCode = branch.branchCode 
	ORDER BY movieStartTime ASC;
	
	Drop View getMovieInfo;
	
	select * from getMovieInfo where movieName = '다크워터스'
	
	
 -->

 </mapper> 
  
  