<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.show.movie.model.dao.ManagerDAO">

	<resultMap id="movie" type="movie">
		<id column="movieCode" property="movieCode" />
		<result column="movieName" property="movieName" />
		<result column="movieAudience" property="movieAudience" />
		<result column="movieTicketRate" property="movieTicketRate" />
		<result column="movieTitle" property="movieTitle" />
		<result column="movieSynopsis" property="movieSynopsis" />
		<result column="moviePrice" property="moviePrice" />
		<result column="moviePoster" property="moviePoster" />
		<result column="moviePosterBG" property="moviePosterBG" />
		<result column="movieImages" property="movieImages" />
		<result column="movieTime" property="movieTime" />
	</resultMap>

	<resultMap id="branch" type="branch">
		<id column="branchCode" property="branchCode" />
		<result column="branchName" property="branchName" />
		<association property="location" javaType="location">
			<result column="locationCode" property="locationCode" />
		</association>
	</resultMap>

	<insert id="insertMovie">
		INSERT INTO movie (managerCode,
		movieName,movieAudience,movieUpdate,
		movieSynopsis, moviePoster, moviePosterBG, movieImages, movieTime)
		VALUES (
		( SELECT managerCode FROM manager where
		managerId=#{manager.managerId}),
		#{movieName},0,NOW(),
		#{movieSynopsis}, #{moviePoster}, #{moviePosterBG},
		#{movieImages},#{movieTime}
		)
	</insert>

	<select id="getMovieList" resultMap="movie">
		SELECT
		movieName,movieName,moviePoster FROM movie
		WHERE managerCode = (SELECT
		managerCode FROM manager WHERE managerId = #{managerId})
	</select>

	<select id="getLocationList" resultType="location">
		SELECT
		location.locationCode, location.locationName, COUNT(*) AS countBranch
		from location,branch
		WHERE branch.locationCode = location.locationCode
		GROUP BY location.locationCode;
	</select>
	<select id="getBranchList" resultMap="branch"
		parameterType="location">
		SELECT * FROM movie.branch
		<choose>
			<when test='locationCode != null'>
				WHERE locationCode = #{locationCode}
			</when>
			<!-- <otherwise> WHERE locationCode=1 </otherwise> -->
		</choose>
	</select>


	<select id="getTheaterList" resultType="theater">
		SELECT theaterCode,
		theaterName, branchCode AS 'branch.branchCode' FROM movie.theater
		WHERE branchCode =
		(SELECT branchCode FROM branch WHERE branchName = #{branchName});
	</select>

	<insert id="insertTheater">
			INSERT INTO
			movieInfo(movieCode, theaterCode,movieDate)
			VALUES
			<foreach item="item" index="index" collection="theaterName" separator=","> 
			(
			(SELECT movieCode FROM movie WHERE movieName = #{movieName}),
			(SELECT theaterCode FROM theater WHERE theaterName = #{item}),
			(SELECT date_format(now(),'%Y-%m-%d') FROM dual)
			)
		</foreach>
	</insert>

</mapper> 
  
  